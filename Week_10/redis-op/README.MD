# 环境配置
redis：6.0.9

系统：OSX big sur

# 1.主从复制

配置文件参考redis-master-slave-replica文件夹。
从默认配置文件中复制出第二个配置文件，redis-slave.conf。修改端口为6380
执行以下命令启动两个redis server。
```
redis-server
redis-server redis-slave.conf
```
进入第二个server的客户端，并执行主从配置命令
```
redis-cli -h 127.0.0.1 -p 6380
slaveof 127.0.0.1 6379
```
即完成主从复制配置，其中主可写可读，从只能读。经过验证，以上配置生效。

# 2.sentinel模式

配置文件参考redis-master-slave-sentinel文件夹。

首先启动3个server，端口为6379，6380，6381。其中6379为master，6380和6381为slave。

配置sentinel配置文件
```
port 26379
sentinel myid 86ec97b2dc9493e18cc1451fb84e16304c49aeb8
sentinel deny-scripts-reconfig yes
sentinel monitor mymaster 127.0.0.1 6380 1
sentinel down-after-milliseconds mymaster 10000

logfile "/Users/haoyongchen/Desktop/sentinel.log"
# Generated by CONFIG REWRITE
protected-mode no
```
启动sentinel
```
redis-sentinel sentinel-new.conf
```
启动之后可以在日志文件中打出以下日志。
```
7429:X 06 Jan 2021 15:50:39.073 * Running mode=sentinel, port=26379.
7429:X 06 Jan 2021 15:50:39.073 # Sentinel ID is 86ec97b2dc9493e18cc1451fb84e16304c49aeb8
```

sentinel启动之后手动关闭master，sentinel监测到主下线之后自动将6380选举为主，日志如下。
```
7429:X 06 Jan 2021 15:52:48.719 # +sdown master mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.719 # +odown master mymaster 127.0.0.1 6379 #quorum 1/1
7429:X 06 Jan 2021 15:52:48.719 # +new-epoch 4
7429:X 06 Jan 2021 15:52:48.719 # +try-failover master mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.722 # +vote-for-leader 86ec97b2dc9493e18cc1451fb84e16304c49aeb8 4
7429:X 06 Jan 2021 15:52:48.722 # +elected-leader master mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.723 # +failover-state-select-slave master mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.780 # +selected-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.780 * +failover-state-send-slaveof-noone slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.871 * +failover-state-wait-promotion slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.951 # +promoted-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:48.951 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:49.035 * +slave-reconf-sent slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:50.052 * +slave-reconf-inprog slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:50.052 * +slave-reconf-done slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:50.113 # +failover-end master mymaster 127.0.0.1 6379
7429:X 06 Jan 2021 15:52:50.113 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380
7429:X 06 Jan 2021 15:52:50.114 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380
7429:X 06 Jan 2021 15:52:50.114 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
7429:X 06 Jan 2021 15:53:00.183 # +sdown slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380
```
根据日志可以看出，6379被sdown，failover几次之后end，将master切换为6380.

# 3.redis-cluster
配置文件参考redis-cluster文件夹。

共有6个节点，6379-6384。

每个配置文件夹中需要修改配置文件端口，开启集群配置。具体涉及到的需要变更的配置如下。
```
port 6379（每个节点的端口号）
daemonize yes
bind 127.0.0.1（绑定当前机器 IP）
dir ./（数据文件存放位置）
pidfile /var/run/redis_6379.pid（pid 9001和port要对应）
cluster-enabled yes（启动集群模式）
cluster-config-file nodes6379.conf（9001和port要对应）
cluster-node-timeout 15000
appendonly yes
```
其他五个server也同样配置。

配置好后分别启动6个server，再执行以下命令开启集群模式。
```
redis-cli --cluster create 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6382 127.0.0.1:6383 127.0.0.1:6384 127.0.0.1:6379 --cluster-replicas 1
```
启动成功后，登陆任意机器，可以查看集群信息。
```
localhost:6380> cluster nodes
cb7c5932740d1d50d596e314670f43e6bc21325b 127.0.0.1:6379@16379 master - 0 1609940560000 6 connected
c929d41dce19d3a534c9556ee0816d6d31f773f7 127.0.0.1:6380@16380 myself,master - 0 1609940561000 1 connected 0-5460
f72dcb3af673ea68bb7d9817ae14cb6858b6177c 127.0.0.1:6384@16384 master - 0 1609940560283 5 connected
b1dc916c5d1e3649a96571ee1ada374c091d5b07 127.0.0.1:6382@16382 master - 0 1609940562314 3 connected 10923-16383
b1bc0ec1dac55f018989d655591adc6dd7b6a371 127.0.0.1:6383@16383 master - 0 1609940561297 4 connected
0bfe5e8ffe62541a2042188231a7d9d79074d685 127.0.0.1:6381@16381 master - 0 1609940560000 2 connected 5461-10922

localhost:6380> cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:11728
cluster_stats_messages_pong_sent:11650
cluster_stats_messages_meet_sent:5
cluster_stats_messages_publish_sent:29080
cluster_stats_messages_sent:52463
cluster_stats_messages_ping_received:11640
cluster_stats_messages_pong_received:11733
cluster_stats_messages_meet_received:10
cluster_stats_messages_publish_received:11634
cluster_stats_messages_received:35017
```
可知集群模式配置成功。
